services:
    postgres:
        restart: always
        image: postgres:15
        env_file:
        - ../.env
        environment:
            POSTGRES_PASSWORD: ${DB_POSTGRES_PASSWORD}
            POSTGRES_USER: ${DB_POSTGRES_USERNAME}
            POSTGRES_DB: ${DB_POSTGRES_NAME}
        ports:
            - "${DB_POSTGRES_PORT}:5432"

    redis:
        image: redis:7
        command: redis-server --requirepass ${REDIS_PASSWORD}
        env_file:
            - ../.env
        environment:
            REDIS_PASSWORD: ${REDIS_PASSWORD}
                       
    celery:
        restart: always
        image: lyapinvladislav/lab_2
        command: celery -A app.worker.celery worker --loglevel=info
        env_file:
            - ../.env
        depends_on:
            - redis
            - postgres
            
    app:
        restart: always
        image: lyapinvladislav/lab_2
        command: sh -c "uvicorn app.main:app --host 0.0.0.0 --port 8080 --workers 4"
        env_file:
            - ../.env
        depends_on:
            - redis
            - postgres
        ports:
            - "80:8080"